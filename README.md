# VA Space Allocator

A prototype VA space allocator that implements an arena-based architecture with specialized strategies for different size classes.
Note: This readme was generated by cursor based on the prompt: "Update the README detailing the two strategies and draw ascii art to compare the results"

## Architecture Overview

### Arena Allocator
```
┌──────────────────────────────────────────────────────┐
│                     Arena Allocator                  │
├─────────────┬─────────────┬─────────────┬────────────┤
│  Arena 0    │  Arena 1    │  Arena 2    │  Arena 3   │
│ (≤512B)     │ (≤1KB)      │ (≤2KB)      │ (≤4KB)     │
│ [Slab]      │ [Slab]      │ [Slab]      │ [Object]   │
├─────────────┼─────────────┼─────────────┼────────────┤
│  Arena 4    │  Arena 5    │  Arena 6    │  Arena 7   │
│ (≤64KB)     │ (≤2MB)      │ (≤32MB)     │ (>32MB)    │
│ [Object]    │ [Object]    │ [Object]    │ [Object]   │
└─────────────┴─────────────┴─────────────┴────────────┘
```

### Default Allocator
```
┌──────────────────────────────────────────────────────┐
│                 Single Large Reservation             │
│                                                      │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  │
│  │ Block 1 │  │ Block 2 │  │ Block 3 │  │ Block 4 │  │
│  └─────────┘  └─────────┘  └─────────┘  └─────────┘  │
│                                                      │
│  One strategy for all sizes, leading to fragmentation│
└──────────────────────────────────────────────────────┘
```

## Allocation Strategies

### 1. Slab Allocator (Arenas 0-2, ≤2KB)
```
+------------------+  Reservation (2MB/4MB)
|  +------------+  |  ┌─────────┐
|  |  512B      |  |  │ Block 1 │
|  +------------+  |  ├─────────┤
|  |  512B      |  |  │ Block 2 │
|  +------------+  |  ├─────────┤
|  |  512B      |  |  │ Block 3 │
|  +------------+  |  ├─────────┤
|  |    ...     |  |  │   ...   │
|  +------------+  |  └─────────┘
+------------------+  Bitmap tracks free blocks
```

### 2. Object Allocator (Arenas 3-7, >2KB)
```
+------------------+  Reservation (8MB-512MB)
|  +------------+  |  ┌─────────────┐
|  |  Free      |  |  │ Free Block  │
|  +------------+  |  ├─────────────┤
|  |  Used      |  |  │ Used Block  │
|  +------------+  |  ├─────────────┤
|  |  Free      |  |  │ Free Block  │
|  +------------+  |  ├─────────────┤
|  |    ...     |  |  │     ...     │
|  +------------+  |  └─────────────┘
+------------------+  Radix tree for size ordering
```

## Size Classes and Reservation Sizes

```
┌─────────────┬───────────────┬──────────────┐
│ Size Class  │ Reservation   │ Strategy     │
├─────────────┼───────────────┼──────────────┤
│ ≤ 512B      │ 2MB           │ Slab         │
│ ≤ 1KB       │ 2MB           │ Slab         │
│ ≤ 2KB       │ 4MB           │ Slab         │
│ ≤ 4KB       │ 8MB           │ Object       │
│ ≤ 64KB      │ 32MB          │ Object       │
│ ≤ 2MB       │ 64MB          │ Object       │
│ ≤ 32MB      │ 512MB         │ Object       │
│ > 32MB      │ Physical      │ Object       │
└─────────────┴───────────────┴──────────────┘
```

## Performance Comparison

### Small Allocations (4KB)
```
┌─────────────┬─────────┬─────────┬─────────┐
│ Metric      │ Default │ Arena   │ Diff    │
├─────────────┼─────────┼─────────┼─────────┤
│ Min (μs)    │ 0.42    │ 0.25    │ -40%    │
│ Max (μs)    │ 26.63   │ 23.15   │ -13%    │
│ Mean (μs)   │ 4.45    │ 4.38    │ -2%     │
│ Median (μs) │ 5.28    │ 4.61    │ -13%    │
└─────────────┴─────────┴─────────┴─────────┘
```

### Large Allocations (1MB)
```
┌─────────────┬─────────┬─────────┬─────────┐
│ Metric      │ Default │ Arena   │ Diff    │
├─────────────┼─────────┼─────────┼─────────┤
│ Min (μs)    │ 0.22    │ 0.13    │ -41%    │
│ Max (μs)    │ 19.35   │ 5.45    │ -72%    │
│ Mean (μs)   │ 3.09    │ 0.34    │ -89%    │
│ Median (μs) │ 3.32    │ 0.31    │ -91%    │
└─────────────┴─────────┴─────────┴─────────┘
```

## Key Features

### Arena Allocator
1. **Multiple Arenas**
   - 8 specialized arenas for different size classes
   - Each arena manages its own reservations
   - Automatic selection of appropriate arena based on size

2. **Slab Allocator (Arenas 0-2)**
   - Fixed-size blocks for small allocations
   - Bitmap-based free block tracking
   - O(1) allocation and deallocation
   - Minimal fragmentation

3. **Object Allocator (Arenas 3-7)**
   - Variable-size blocks for larger allocations
   - Radix tree for size-based block lookup
   - Address-ordered list for coalescing
   - Best-fit allocation strategy

### Default Allocator
- Single large reservation at initialization
- One strategy for all allocation sizes
- Higher fragmentation due to mixed size classes
- Simpler but less efficient for mixed workloads

## Building and Testing

```bash
./build.sh
```

## License

This project is licensed under the MIT License - see the LICENSE file for details.